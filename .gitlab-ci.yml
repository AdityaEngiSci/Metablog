stages:
  # - build
  # - test
  - publish
  - deploy
  
# build-backend:
#   stage: build
#   image: maven:latest
#   before_script:
#       - cd metaBlog-backend
#   tags:
#     - dalfcs_docker_autoscale
#   script:
#     - echo "Starting backend build......"
#     - mvn clean install
#     - echo "Compile complete."
#     - echo "Backend build completed"
#   artifacts:
#     paths: 
#       - metaBlog-backend/target

# build-frontend:
#   stage: build
#   image: node:latest
#   tags:
#     - dalfcs_docker_autoscale
#   before_script:
#     - cd metablog-frontend
#     - npm install
#     - npm i react-icons
#   script:
#     - echo "Frontend building started......"
#     - npm run build
#   artifacts:
#     paths:
#       - metablog-frontend/build

# test-backend:
#     stage: test
#     image: maven:latest
#     tags:
#     - dalfcs_docker_autoscale
#     before_script: 
#         - cd metaBlog-backend
#     script:
#         - echo "backend testing started......"
#         - mvn test
#         - echo "backedn testing completed......"
#     only: 
#       - develop
#       - main

publish_backend:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  before_script:
      - cd metaBlog-backend
      - ls
      - pwd
      - echo "Docker login started"
      - docker login -u $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD docker.io
      - echo "Docker login success"
  tags:
    - dalfcs_docker_kvm
  script:
    - ls
    - pwd
    - echo "Docker build for backend started"
    - docker build -t $DOCKER_HUB_USERNAME/metablog_backend .
    - echo "Docker build for backend done now pushing the image to the docker hub"
    - docker push $DOCKER_HUB_USERNAME/metablog_backend
    - echo "Docker image for backend pushed to the docker hub"
  only:
    - main

publish_frontend:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
  before_script:
      - cd metablog-frontend
      - echo "Docker login started"
      - docker login -u $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD docker.io
      - echo "Docker login success"
  tags:
    - dalfcs_gitlab_docker_ci
  script:
    - echo "Docker build for frontend started"
    - docker build -t $DOCKER_HUB_USERNAME/metablog_frontend .
    - echo "Docker build for frontend done now pushing the image to the docker hub"
    - docker push $DOCKER_HUB_USERNAME/metablog_frontend
    - echo "Docker image for frontend pushed to the docker hub"
  only:
    - main
  
deploy-backend:
  stage: deploy
  image: alpine:latest
  before_script:
    - cd metaBlog-backend
    - apk update
    - apk-get install openssh
    - apk-get install sshpass
  tags:
    - dalfcs_docker_kvm
  script:
    - echo "Docker login stared"
    - sshpass -p $VM_PASSWORD ssh -o StrictHostKeyChecking=no student@$VM_ADDRESS "docker login -u $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD docker.io"
    - echo "Docker login done successfully..."
  only:
    - main
